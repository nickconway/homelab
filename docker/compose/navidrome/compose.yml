networks:
  proxy:
    external: true

services:
  navidrome:
    image: deluan/navidrome:0.58.5@sha256:648ebd45c50c58edc7ad9f0cc3b4411a1bece16c81f0b3630a0ab0a739c6d7ec
    user: 1000:1000 # should be owner of volumes
    restart: unless-stopped
    networks:
      - proxy
    environment:
      ND_SCANSCHEDULE: 1h
      ND_LOGLEVEL: info
      ND_SESSIONTIMEOUT: 24h
      ND_BASEURL: "https://${SERVICE_SUBDOMAIN:-music}.${SERVICES_BASE_DOMAIN}"
      ND_SPOTIFY_ID: ${ND_SPOTIFY_ID}
      ND_SPOTIFY_SECRET: ${ND_SPOTIFY_SECRET}
      ND_LASTFM_APIKEY: ${ND_LASTFM_APIKEY}
      ND_LASTFM_SECRET: ${ND_LASTFM_SECRET}
      ND_LISTENBRAINZ_BASEURL: http://maloja:42010/apis/listenbrainz/1/
      ND_ENABLEINSIGHTSCOLLECTOR: true
    volumes:
      - ./data:/data
      - /mnt/nas/content/media/music:/music:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.middlewares=crowdsec-traefik-bouncer"
      - "traefik.http.routers.navidrome.rule=Host(`${SERVICE_SUBDOMAIN:-music}.${SERVICES_BASE_DOMAIN}`)"
      - "traefik.http.routers.navidrome.tls=true"
      - "traefik.http.services.navidrome.loadbalancer.server.port=4533"
