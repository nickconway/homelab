networks:
  proxy:
    external: true
  tranga:
    name: tranga

services:
    tranga-api:
      image: glax/tranga-api:latest
      volumes:
        - /mnt/nas/content/media/manga:/Manga
        - ./data:/usr/share/tranga-api
      restart: unless-stopped
      environment:
        - PUID=1000
        - PGID=1000
        - POSTGRES_HOST=tranga-postgres
        - POSTGRES_USER=${POSTGRES_USER:-tranga}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      networks:
        - proxy
        - tranga
      labels:
        - "traefik.enable=true"
        - "traefik.http.middlewares.tranga-api.stripprefix.prefixes=/api/"
        - "traefik.http.routers.tranga-api.middlewares=crowdsec-traefik-bouncer,auth,tranga-api"
        - "traefik.http.routers.tranga-api.rule=Host(`${SERVICE_SUBDOMAIN:-tranga}.${SERVICES_BASE_DOMAIN}`) && PathPrefix(`/api/`)"
        - "traefik.http.routers.tranga-api.tls=true"
        - "traefik.http.services.tranga-api.loadbalancer.server.port=6531"

    tranga:
      image: glax/tranga-website:latest
      depends_on:
        - tranga-api
      restart: unless-stopped
      networks:
        - proxy
        - tranga
      environment:
        - PUID=1000
        - PGID=1000
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.tranga.middlewares=crowdsec-traefik-bouncer,auth"
        - "traefik.http.routers.tranga.rule=Host(`${SERVICE_SUBDOMAIN:-tranga}.${SERVICES_BASE_DOMAIN}`)"
        - "traefik.http.routers.tranga.tls=true"
        - "traefik.http.services.tranga.loadbalancer.server.port=80"

    tranga-postgres:
      image: docker.io/library/postgres:18.0@sha256:41fc5342eefba6cc2ccda736aaf034bbbb7c3df0fdb81516eba1ba33f360162c
      environment:
        - POSTGRES_USER=${POSTGRES_USER:-tranga}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      networks:
        - tranga
      volumes:
        - ./data/db:/var/lib/postgresql
      healthcheck:
        test: ["CMD-SHELL", "pg_isready", "-U", "postgres"]
        interval: 30s
        timeout: 60s
        retries: 5
        start_period: 80s
      restart: unless-stopped
